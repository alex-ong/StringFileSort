Note:
this code is just a gist.

Some parts may not work perfectly.